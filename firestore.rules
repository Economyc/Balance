rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Gastos
      match /expenses/{expenseId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update: if request.auth != null
          && request.auth.uid == userId
          && isValidExpense(request.resource.data);
        allow delete: if request.auth != null && request.auth.uid == userId;
      }

      // Categorías
      match /categories/{categoryId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update: if request.auth != null
          && request.auth.uid == userId
          && isValidCategory(request.resource.data);
        allow delete: if request.auth != null && request.auth.uid == userId;
      }

      // Resto de documentos del usuario
      match /{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }

  // Valida la estructura de un gasto
  function isValidExpense(data) {
    return data.keys().hasAll(['name', 'amount', 'categoryId', 'date'])
      && data.name is string
      && data.name.size() > 0
      && data.name.size() <= 200
      && data.amount is number
      && data.amount > 0
      && data.amount <= 1000000000
      && data.categoryId is string
      && data.categoryId.size() > 0
      && data.date is string;
  }

  // Valida la estructura de una categoría
  function isValidCategory(data) {
    return data.keys().hasAll(['name', 'icon'])
      && data.name is string
      && data.name.size() > 0
      && data.name.size() <= 100
      && data.icon is string
      && data.icon.size() > 0;
  }
}
